<div class="container mx-auto p-6 max-w-2xl">
    <h1 class="text-3xl font-bold mb-4">Recipe Details</h1>

    {% if recipes %}
        <ul class="space-y-6">
            {% for recipe in recipes %}
                <li class="border rounded-lg shadow-lg p-6 bg-white transition duration-200 hover:shadow-xl">
                    <h2 class="text-2xl font-semibold">{{ recipe.recipe_name }}</h2>

                    <div class="mt-2">
                        {% if recipe.image_url %}
                            <img src="{{ recipe.image_url }}" alt="{{ recipe.recipe_name }}" class="w-56 h-auto rounded-md" />
                        {% else %}
                            <p class="text-gray-500">No image available.</p>
                        {% endif %}
                    </div>

                    <div class="mt-4">
                        <p><strong>Cooking Time:</strong> {{ recipe.cooking_time }}</p>
                        <p><strong>Servings:</strong> {{ recipe.servings }}</p>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-lg font-semibold">Ingredients:</h3>
                        <ul class="list-disc pl-5">
                            {% for ingredient in recipe.ingredients.all %}
                                <li>{{ ingredient.name }}</li>
                            {% empty %}
                                <li>No ingredients available.</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-lg font-semibold">Instructions:</h3>
                        <ol class="list-decimal pl-5">
                            {% for instruction in recipe.recipe_instructions.all|dictsort:"step_number" %}
                                <li>{{ instruction.description }}</li>
                            {% empty %}
                                <li>No instructions available.</li>
                            {% endfor %}
                        </ol>
                    </div>

                    <p><strong>Average Rating:</strong> 
                        <span class="average-rating-{{ recipe.id }}">{{ recipe.average_rating|default:"No ratings yet." }}</span>
                    </p>                    

                    <ul class="list-disc pl-5 review-list-{{ recipe.id }}">
                        {% if recipe.ratings_list.all %}
                            {% for review in recipe.ratings_list.all %}
                                <li class="mt-2 review-item-{{ review.id }}">
                                    <strong>Rating:</strong> {{ review.score }} - 
                                    <em class="review-content-{{ review.id }}">{{ review.content }}</em>
                                    <br>
                                    <small class="text-gray-500">Reviewed on {{ review.created_at }}</small>
                                    <br>
                                    <a href="{% url 'edit_rating_review' review.id %}?next={{ request.path }}" class="edit-review-button">Edit</a>
                                    <a href="{% url 'delete_rating_review' review.id %}?next={{ request.path }}" class="delete-review-button">Delete</a>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>                    

                    <div class="mt-4">
                        <form id="rating-form-{{ recipe.id }}" class="rating-form">
                            <input type="hidden" name="recipe_id" value="{{ recipe.id }}">
                            <label for="score">Rating (1-5):</label>
                            <input type="number" name="score" min="1" max="5" class="border p-2 rounded w-16" required>
                            <label for="content">Review:</label>
                            <textarea name="content" rows="2" class="border p-2 rounded w-full"></textarea>
                            <button type="submit" class="bg-[#556B2F] text-white py-2 px-4 rounded hover:bg-[#6B8E23] transition">Submit Review</button>
                        </form>
                    </div>

                    <div class="mt-4">
                        <a href="{% url 'main:show_main' %}" class="ml-2">
                            <button class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 transition">Back</button>
                        </a>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-center mt-4 text-gray-500">No recipes available matching "{{ recipe_id }}".</p>
    {% endif %}
</div>

<script>
    document.querySelectorAll('.rating-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const recipeId = this.querySelector('input[name="recipe_id"]').value;

            // Validate that the score is provided
            const score = formData.get('score');
            if (!score) {
                alert("Rating is required.");
                return;
            }

            fetch("{% url 'create_rating_review' %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": "{{ csrf_token }}",
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const reviewsList = document.querySelector('.review-list-' + recipeId);

                    // Append new review
                    reviewsList.innerHTML += `<li class="mt-2 review-item-${data.review.id}">
                        <strong>Rating:</strong> ${data.review.score} - 
                        <em class="review-content-${data.review.id}">${data.review.content || ''}</em>  
                        <br>
                        <small class="text-gray-500">Reviewed on ${data.review.created_at}</small>
                        <br>
                        <a href="/catalog/edit-rating-review/${data.review.id}/?next={{ request.path }}" class="edit-review-button">Edit</a>
                        <a href="/catalog/delete-rating-review/${data.review.id}/?next={{ request.path }}" class="delete-review-button">Delete</a>
                    </li>`;

                    form.reset();

                    // Update the average rating display
                    const averageRatingElement = form.closest('li').querySelector('.average-rating-' + recipeId);
                    averageRatingElement.textContent = data.average_rating;

                    // Remove "No reviews yet." if it was present
                    const noReviewsMessage = reviewsList.querySelector('li:contains("No reviews yet.")');
                    if (noReviewsMessage) {
                        noReviewsMessage.remove();
                    }
                } else {
                    alert("Error submitting review: " + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>
